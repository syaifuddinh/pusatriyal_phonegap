<!DOCTYPE html>
<html lang="en">

<head>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />

<style>

#mapid { height: 100%; margin-top: 20px; }

</style>

</head>

<body>
<div class="pusatriyal-submit btn-group">
  		<button type="button" class="btn btn-success" id="selesai" onclick="selesai()">Selesai</button>
</div>
<div id="weathermap"></div>
<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>

<script>
var interval;
$(document).ready(function(){
  getdata();
});

cekdata();

function cekdata(){
  interval = setInterval(function () {
    getdata();
  }, 5000);
}

function getdata(){
  $.ajax({
    type: 'get',
    data: {sr_id, petugas, type:'C'},
    dataType: 'json',
    url: url('api/getmap'),
    success : function(response){
      count = response.length;

      // polylinepoint = [];
      //
      // for (i = 0; i < response.length; i++) {
      //    polylinepoint.push([response[i].rdt_latitude, response[i].rdt_longitude]);
      // }
      // console.log(polylinepoint.length);

      getmap(response, count);
    }
  });
}

function getmap(response, count){
  var map = L.map('mapid').setView([response[count - 1].cdt_latitude, response[count - 1].cdt_longitude], 13);
  L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  // var polyline = L.polyline(polylinepoint).addTo(map);
  // var polyline = L.polyline(polylinepoint, {color: 'red'}).addTo(map);
  //
  // map.fitBounds(polyline.getBounds());
  var marker = L.marker([response[0].cdt_latitude, response[0].cdt_longitude],
       {
         title: 'Lokasi Awal'}            // Adjust the opacity
       )
       .addTo(map);

  marker.bindPopup("Lokasi Awal").openPopup();
  // L.marker(response[count - 1].rdt_latitude, response[count - 1].rdt_longitude).addTo(map);

  var stuSplit = L.latLng(response[count - 1].cdt_latitude, response[count - 1].cdt_longitude);
  var myMarker = L.circleMarker(stuSplit,
    { title: 'unselected' })
        .addTo(map);
}

function selesai(){
  stop(sr_id);
  clearInterval(interval);
  Routing.load_page('includes/distribusi/jadwal-pengantaran-corporate/index.html');
}

// function buildMap(lat,lon)  {
//     document.getElementById('weathermap').innerHTML = "<div id='map' style='width: 100%; height: 100%;'></div>";
//     var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
//                     osmAttribution = 'Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors,' +
//                         ' <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
//     osmLayer = new L.TileLayer(osmUrl, {maxZoom: 18, attribution: osmAttribution});
//     var map = new L.Map('map');
//     map.setView(new L.LatLng(lat,lon), 9 );
//     map.addLayer(osmLayer);
//     var validatorsLayer = new OsmJs.Weather.LeafletLayer({lang: 'en'});
//     map.addLayer(validatorsLayer);
// }

document.getElementById('weathermap').innerHTML = "<div id='mapid' style='width: 100%; height: 100%;'></div>";

</script>

</body>

</html>
