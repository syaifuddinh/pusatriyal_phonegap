<!DOCTYPE html5>
<html>
	<head>
		<title>Dashboard</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv=“Content-Security-Policy” content=“default-src ‘self’ gap://ready file://* *; style-src ‘self’ ‘unsafe-inline’; script-src ‘self’ ‘unsafe-inline’ ‘unsafe-eval’”/>
		<link rel="shortcut icon" href="asset/img/icon-pusat-riyal.png">
		<link rel="stylesheet" type="text/css" href="./node_modules/bootstrap/dist/css/bootstrap.css">
		<link rel="stylesheet" type="text/css" href="./node_modules/font-awesome/css/font-awesome.css">
		<link rel="stylesheet" type="text/css" href="./css/iziToast.min.css">
		<link rel="stylesheet" type="text/css" href="leaflet/leaflet.css">
		<link rel="stylesheet" type="text/css" href="./node_modules/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css">
		<link rel="stylesheet" type="text/css" href="./node_modules/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css">
		<link rel="stylesheet" type="text/css" href="./node_modules/select2/dist/css/select2.min.css">
		<style>
			.rounded-btn {
		width: 12mm;
		height: 12mm;
		border-radius:1000mm;
		position: fixed;
		bottom: 7mm;
		right: 5mm;
		display: flex;
		justify-content: center;
		align-content: center;
		color: white;
		z-index: 1000;
		box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.6)
		}
			.pusatriyal-submit {
				position: fixed;
			bottom: 7mm;
			right: 5mm;
			display: flex;
			}
		div .maincard {
			margin-bottom: 40mm
		}
		.card-body:hover:not(.card-forlist){
			background: #e6e6e6;
		}
		content {
			margin-top: 20mm;
		}
		</style>
		<!-- harus ditempatkan dibawah sendiri -->
		<link rel="stylesheet" type="text/css" href="./asset/css/alamraya-style.css">
		<!-- End -->
	</head>
	<body style="padding-top: 10mm">
		<div id="loading_icon" class='hidden' style="position: fixed;bottom: 2mm;left: 3mm;z-index:60;">
			<img src="img/ellipsis.gif" alt="Loading...." style="width: 20mm;height: auto">
		</div>
		<div class="bg-top"></div>
		<div class="bg-bottom"></div>
		<section class="sidebar">
			<div class="sidebar-header">
				<a href="#">
					<img src="asset/img/logo-pusat-riyal.png" width="170px" height="auto">
				</a>
			</div>
			<ul>
				<li class="pt-3 pr-3 pl-3">
				<select class="form-control form-control-sm" id="select_comp"></select>
			</li>
			<li>
				<a href="#">Profile</a>
			</li>
			<li>
				<a href="#">Credit</a>
			</li>
		</ul>
		<div class="sidebar-footer">
			<ul class="sidebar-logout">
				<li>
					<a href="#" id="btn-logout">Logout</a>
				</li>
			</ul>
		</div>
	</section>
	<div class="sidebar-menu-off"></div>
	<section class="menu-header" style="background: #007139;position:fixed;width: 100%;top: 0;left: 0">
		<button type="button" class="btn text-alamraya" id="btn-menu">
			<i class="fa fa-bars"></i>
		</button>
		<button type="button" class="btn text-alamraya" id="btn-backward" style="display:none">
			<i class="fa fa-chevron-left"></i>
		</button>
		<button class="btn text-alamraya" type="button">
			<i class="fa fa-bell-o"></i>
		</button>
	</section>
	<content></content>
	<script type="text/javascript" src="cordova.js"></script>
	<script type="text/javascript" src="config/config.js"></script>
	<script type="text/javascript" src="node_modules/jquery/dist/jquery.js"></script>
	<script type="text/javascript" src="node_modules/bootstrap/dist/js/bootstrap.js"></script>
	<script type="text/javascript" src="js/iziToast.min.js"></script>
	<script type="text/javascript" src="leaflet/leaflet.js"></script>
	<script type="text/javascript" src="node_modules/bootstrap-datetimepicker/js/moment.js"></script>
	<script type="text/javascript" src="node_modules/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
	<script type="text/javascript" src="node_modules/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>
	<script type="text/javascript" src="node_modules/select2/dist/js/select2.min.js"></script>
	<script type="text/javascript" src="node_modules/jquery-maskmoney/dist/jquery.maskMoney.min.js"></script>
	<script type="text/javascript" src="node_modules/accounting-js/dist/accounting.umd.js"></script>
	<script type="text/javascript" src="config/config.js"></script>
	<script type="text/javascript" src="config/routing.js"></script>
	<script type="text/javascript" src="js/features/logout.js"></script>
	<script type="text/javascript" src="js/notification/SmartNotification.min.js"></script>
	<script type="text/javascript" src="js/pusher.min.js"></script>

	<script type="text/javascript">	
	$(document).ready(function(){
		loading_icon = $('#loading_icon');
		iziToast.settings({
			position:'topRight'//Where it will be shown. It can be bottomRight, bottomLeft, topRight, topLeft, topCenter, bottomCenter or center.
		})
		$.extend( $.fn.datepicker.defaults, {disableTouchKeyboard:true});
		$(document).ready(function(){
			$('#btn-menu, .sidebar-menu-off').click(function(){
				$('body').toggleClass('sidebar-collapse');
			});
			$('#btn-backward').click(function(){
				Routing.backward();
			});
			Routing.init('content');
			csrf_token = '';
			$.fn.select2.defaults.set("width", "100%");
			$('#btn-logout').click(function(){
				localStorage.removeItem('access_token');
				localStorage.removeItem('refresh_token');
				localStorage.removeItem('token_type');
				localStorage.removeItem('username');
				window.location.href = 'index.html';
			})
		});
		Routing.init('content');
		csrf_token = '';
		$.fn.select2.defaults.set("width", "100%");
		$('#btn-logout').click(function(){
			localStorage.removeItem('access_token');
			localStorage.removeItem('refresh_token');
			localStorage.removeItem('token_type');
			localStorage.removeItem('username');
			window.location.href = 'index.html';
		})
	});
	</script>
	<script type="text/javascript">
		cordova.plugins.diagnostic.requestLocationAuthorization(function(status){
			switch(status){
				case cordova.plugins.diagnostic.permissionStatus.NOT_REQUESTED:
				console.log("Permission not requested");
				break;
				case cordova.plugins.diagnostic.permissionStatus.GRANTED:
				console.log("Permission granted");
				break;
				case cordova.plugins.diagnostic.permissionStatus.DENIED:
				console.log("Permission denied");
				break;
				case cordova.plugins.diagnostic.permissionStatus.DENIED_ALWAYS:
				console.log("Permission permanently denied");
				break;
			}
		}, function(error){
			console.error(error);
		});
		function get_currency(v) {
		if( /^\d([0-9\.]+)$/.test(v) ) {
			var desimal = '';
			if( /\./.test(v) ==  true ) {
				v = parseFloat(v);
				v = v.toFixed(2);
				v = v.toString();
				desimal = v.split('.')[1];
				v = v.split('.')[0];
			}
			v = v.toString();
			var res = v.split('');
			res = res.reverse().join('');
			currStr = v;
			if(res.length > 3) {
				var currPtr = /(\w{3})/g;
				var currStr = res.replace(currPtr, '$1.').split('').reverse().join('').replace(/^\.(.*)/, '$1');
			}
			currStr += desimal != '' ? ',' + desimal : '';
			return currStr;
		}
		return v;
		}
	</script>
	<script type="text/javascript">
		function onDeviceReady(){
			/**
			 * Determine whether the file loaded from PhoneGap or not
			 */
			function isPhoneGap() {
			    return (window.cordova || window.PhoneGap || window.phonegap)
			    && /^file:\/{3}[^\/]/i.test(window.location.href)
			    && /ios|iphone|ipod|ipad|android/i.test(navigator.userAgent);
			}

			if ( isPhoneGap() ) {
			    cordova.plugins.diagnostic.isLocationAvailable(function(available){
				    console.log("Location is " + (available ? "available" : "not available"));
				    if (!available) {
				    	var confirmation = confirm('GPS tidak aktif!\n'+
				    		'Ingin masuk ke pengaturan GPS?');

				    	if (confirmation) {
				    		cordova.plugins.diagnostic.switchToLocationSettings();
				    	}
				    }
				}, function(error){
				    console.error("The following error occurred: "+error);
				});

			    console.log('Running on phonegap');

			} else {
			    console.log("Not running on PhoneGap!");
			}



			$.ajax({
				url:url('api/get_Mmember'),
				dataType:'json',
				type:'get',
				success:function(res){
					m_mem_global = res.data;
					console.log(m_mem_global);
					var datay;
					for(var d = 0;d<m_mem_global.length; d++){
						datay = m_mem_global[d];

							var appendx = '<option value="'+ datay.c_id +'">'+datay.c_name+'</option>'

						$('#select_comp').append(appendx);
					}
				},
				error: function(jqXHR, exception) {
					if (jqXHR.status === 0) {
					    alert('Not connect.\n Verify Network.');
					} else if (jqXHR.status == 404) {
					    alert('Requested page not found. [404]');
					} else if (jqXHR.status == 500) {
					    alert('Internal Server Error [500].');
					} else if (exception === 'parsererror') {
					    alert('Requested JSON parse failed.');
					} else if (exception === 'timeout') {
					    alert('Time out error.');
					} else if (exception === 'abort') {
					    alert('Ajax request aborted.');
					} else {
					    alert('Uncaught Error.\n' + jqXHR.responseText);
					}
				},
				complete:function(){
					var get_m_comp_id = localStorage.getItem('m_comp_id');
					var get_m_comp_name = localStorage.getItem('m_comp_name');
					var get_m_comp_code = localStorage.getItem('m_comp_code');
					if (get_m_comp_id) {
						console.log('statement if is true');
						$('#select_comp').val(parseInt(get_m_comp_id));
					} else {
						var idx = $('#select_comp').val();

						var pengulangan, sama;
						for (var i = 0; i < m_mem_global.length; i++) {
							pengulangan = m_mem_global[i];
							if (pengulangan.c_id === parseInt(idx)) {
								sama = pengulangan;
							}
						}

						localStorage.setItem('m_comp_code', sama.c_code);
						localStorage.setItem('m_comp_id', $('#select_comp').val());
						localStorage.setItem('m_comp_name', $('#select_comp option:selected').text());
					}
					console.log(localStorage.getItem('m_comp_id'));
					console.log(localStorage.getItem('m_comp_name'));
					console.log(localStorage.getItem('m_comp_code'));
				}
			})

			$('#select_comp').change(function(){
				var idx = $(this).val();
				localStorage.setItem('m_comp_id', idx);
				localStorage.setItem('m_comp_name', $('option:selected',this).text());
				var pengulangan, sama;
				for (var i = 0; i < m_mem_global.length; i++) {
					pengulangan = m_mem_global[i];
					if (pengulangan.c_id === parseInt(idx)) {
						sama = pengulangan;
					}
				}

				localStorage.setItem('m_comp_code', sama.c_code);
			});

		}

		if (navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/)) {
		  document.addEventListener("deviceready", onDeviceReady, false);
		} else {
			$(document).ready(function(){

			  onDeviceReady(); //this is the browser
			});
		}
		var user_comp = localStorage.getItem('m_comp_id');
		var interval;
		var latitude;
		var longitude;
		function start(sr_id){
			geo();
			updatestatus(sr_id, 'start');
			pushgps(sr_id);
		};
		function stop(sr_id){
			stoppush(sr_id, 'stop');
		}
		function geo(){
			var successHandler = function(position) {
				latitude = position.coords.latitude;
				longitude = position.coords.longitude;
				};
				var errorHandler = function (errorObj) {
				alert(errorObj.code + ": " + errorObj.message);
				};
				navigator.geolocation.getCurrentPosition(
				successHandler, errorHandler,
				{enableHighAccuracy: true, maximumAge: 10000});
		//   navigator.geolocation.getCurrentPosition(function(position) {
		//   latitude = position.coords.latitude;
		//   longitude = position.coords.longitude;
		// });
		}
		function pushgps(sr_id){
			interval = setInterval(function () {
				$('#status').text('Sedang Berjalan . . . ');
				$.ajax({
					type: 'get',
					url: url('/api/gpspush'),
					dataType: 'json',
					data: {id:sr_id, latitude, longitude},
					success : function(response){
					}
				});
			}, 5000);
		}
		function updatestatus(sr_id, status){
			$.ajax({
				type: 'get',
				data: {sr_id, status},
				url: url('/api/updatestatus'),
				dataType: 'JSON',
				success : function(response){
				}
			});
		}
		function stoppush(sr_id, status){
			updatestatus(sr_id, status);
			clearInterval(interval);
			$('#status').text('DIberhentikan . . . ');
		}
			user_comp = localStorage.getItem('m_comp_id');
			interval;
		latitude;
		longitude;
		function start(sr_id, type){
			geo();
			updatestatus(sr_id, 'start');
			pushgps(sr_id, type);
		};
		function stop(sr_id){
			stoppush(sr_id, 'stop');
		}
		function geo(){
			var successHandler = function(position) {
				latitude = position.coords.latitude;
				longitude = position.coords.longitude;
				};
				var errorHandler = function (errorObj) {
				alert(errorObj.code + ": " + errorObj.message);
				};
				navigator.geolocation.getCurrentPosition(
				successHandler, errorHandler,
				{enableHighAccuracy: true, maximumAge: 10000});
		//   navigator.geolocation.getCurrentPosition(function(position) {
		//   latitude = position.coords.latitude;
		//   longitude = position.coords.longitude;
		// });
		}
		function pushgps(sr_id, type){
		interval = setInterval(function () {
			$('#status').text('Sedang Berjalan . . . ');
				$.ajax({
					type: 'get',
					url: url('/api/gpspush'),
					dataType: 'json',
					data: {id:sr_id, type, latitude, longitude},
					success : function(response){
					}
				});
			}, 5000);
		}
		function updatestatus(sr_id, status){
			$.ajax({
				type: 'get',
				data: {sr_id, status},
				url: url('/api/updatestatus'),
				dataType: 'JSON',
				success : function(response){
				}
			});
		}
		function stoppush(sr_id, status){
			updatestatus(sr_id, status);
			clearInterval(interval);
			$('#status').text('DIberhentikan . . . ');
		}
	</script>
	<script type="text/javascript">
		PUSHER_APP_ID="691515"
		PUSHER_APP_KEY="dc427b22d37fc68da031"
		PUSHER_APP_SECRET="a3c2fd863104e1f91b42"
		PUSHER_APP_CLUSTER="mt1"
		// Enable pusher logging - don't include this in production
	    Pusher.logToConsole = true;

	    var pusher = new Pusher(PUSHER_APP_KEY, {
	      cluster: PUSHER_APP_CLUSTER,
	      forceTLS: true
	    });

	    var channel = pusher.subscribe('my-channel');
	    channel.bind('my-event', function(data) {
	      
	      navigator.notification.alert(data.message, alertCallback, ['Pusher Get'], ['Oke']);
	      function alertCallback(){
	      	console.log(data);
	      }
	    });


		// Background Mode set enable
		cordova.plugins.backgroundMode.enable();
		cordova.plugins.backgroundMode.excludeFromTaskList();
		cordova.plugins.backgroundMode.overrideBackButton();
		setInterval(function(){
			var is_background_mode = cordova.plugins.backgroundMode.isActive();

			console.log(is_background_mode);
		},  5000);

		cordova.plugins.backgroundMode.setDefaults({
		    title: 'Pusat Riyal',
		    text: 'Menunggu info terbaru ..',
		    icon: 'icon', // this will look for icon.png in platforms/android/res/drawable|mipmap
		    color: '#007139', // hex format like 'F14F4D'
		    resume: true,
		    hidden: false,
		    bigText: false
		})

		cordova.plugins.backgroundMode.on('activate', function() {
		   cordova.plugins.backgroundMode.disableWebViewOptimizations(); 
		});

	</script>
</body>
</html>